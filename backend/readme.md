# ğŸ”§ æ²»å…·ç®¡ç†ç³»çµ± v2.0.0

å®Œæ•´çš„æ²»å…·ç”Ÿå‘½é€±æœŸç®¡ç†ç³»çµ±ï¼Œæ”¯æ´æ”¶é€€æ–™ã€ä½¿ç”¨è¨˜éŒ„ã€æ›´æ›è¿½è¹¤ã€é–‹ç«™æ•¸æ™ºèƒ½è¨ˆç®—ç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®éŒ„

- [åŠŸèƒ½ç‰¹è‰²](#åŠŸèƒ½ç‰¹è‰²)
- [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
- [å¿«é€Ÿé–‹å§‹](#å¿«é€Ÿé–‹å§‹)
- [API æ–‡ä»¶](#api-æ–‡ä»¶)
- [å°ˆæ¡ˆçµæ§‹](#å°ˆæ¡ˆçµæ§‹)
- [è³‡æ–™åº«è¨­è¨ˆ](#è³‡æ–™åº«è¨­è¨ˆ)
- [å¸¸è¦‹å•é¡Œ](#å¸¸è¦‹å•é¡Œ)

---

## âœ¨ åŠŸèƒ½ç‰¹è‰²

### ğŸ” èªè­‰ç³»çµ±
- JWT Token èªè­‰
- è§’è‰²æ¬Šé™ç®¡ç† (admin/user)
- å¯†ç¢¼åŠ å¯† (Bcrypt)
- Token åˆ·æ–°æ©Ÿåˆ¶

### ğŸ”§ æ²»å…·ç®¡ç†
- å®Œæ•´çš„ CRUD æ“ä½œ
- è‡ªè³¼/å®¢ä¾›æ•¸é‡è¿½è¹¤
- æ²»å…·ç‹€æ…‹ç®¡ç† (æ­£å¸¸/è¿”é‚„/å ±å»¢)
- å„²å­˜ä½ç½®ç®¡ç†
- æ›´æ›é€±æœŸè¿½è¹¤ (å¤©æ•¸/æ¬¡æ•¸)
- è‡ªå‹•è¨ˆç®—æ›´æ›ç‹€æ…‹

### ğŸ“¦ æ”¶é€€æ–™ç®¡ç†
- æ‰¹é‡æ”¶æ–™ (æµæ°´è™Ÿèµ·è¨–)
- å°‘é‡æ”¶æ–™ (é€—è™Ÿåˆ†éš”)
- æ‰¹é‡é€€æ–™
- å°‘é‡é€€æ–™
- æ”¶é€€æ–™è¨˜éŒ„æŸ¥è©¢
- çµ±è¨ˆå ±è¡¨

### ğŸ“ è¨˜éŒ„ç®¡ç†
- ä½¿ç”¨è¨˜éŒ„ç™»è¨˜
- æ‰¹é‡ä½¿ç”¨è¨˜éŒ„
- æ›´æ›è¨˜éŒ„ç®¡ç†
- ç•°å¸¸ç‹€æ…‹è¿½è¹¤
- å®Œæ•´çš„æ­·å²è¨˜éŒ„

### ğŸ­ æ©Ÿç¨®ç®¡ç† â­ æ ¸å¿ƒåŠŸèƒ½
- æ©Ÿç¨®è³‡æ–™ç¶­è­·
- **é–‹ç«™æ•¸æ™ºèƒ½è¨ˆç®—**
- æ²»å…·éœ€æ±‚ç®¡ç†
- ç«™é»é…ç½®ç®¡ç†
- ç“¶é ¸åˆ†æ

### ğŸ“Š çµ±è¨ˆåˆ†æ
- æ²»å…·ç‹€æ³ç¸½è¦½
- ä½¿ç”¨çµ±è¨ˆ
- æ›´æ›çµ±è¨ˆ
- æ”¶é€€æ–™çµ±è¨ˆ
- å„€è¡¨æ¿æ•¸æ“š

---

## ğŸ—ï¸ æŠ€è¡“æ¶æ§‹

### å¾Œç«¯
- **æ¡†æ¶**: FastAPI 0.104+
- **è³‡æ–™åº«**: MySQL 8.0+
- **ORM**: åŸç”Ÿ SQL (PyMySQL)
- **èªè­‰**: JWT (python-jose)
- **å¯†ç¢¼åŠ å¯†**: Bcrypt
- **è³‡æ–™é©—è­‰**: Pydantic v2

### å‰ç«¯
- **æŠ€è¡“**: åŸç”Ÿ JavaScript
- **æ¨£å¼**: Tailwind CSS
- **æ¶æ§‹**: SPA (å–®é æ‡‰ç”¨)

### è³‡æ–™åº«ç‰¹è‰²
- 12 å€‹è³‡æ–™è¡¨
- 2 å€‹è¦–åœ– (è‡ªå‹•è¨ˆç®—)
- 3 å€‹è§¸ç™¼å™¨ (è‡ªå‹•æ›´æ–°)
- å®Œæ•´çš„å¤–éµç´„æŸ
- ç´¢å¼•å„ªåŒ–

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### å‰ç½®éœ€æ±‚

- Python 3.10+
- MySQL 8.0+
- Git (å¯é¸)

### Step 1: ä¸‹è¼‰å°ˆæ¡ˆ

å°‡æ‰€æœ‰æª”æ¡ˆæ”¾ç½®åœ¨å°ˆæ¡ˆç›®éŒ„ä¸­ï¼Œçµæ§‹å¦‚ä¸‹ï¼š

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/          # Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ routers/         # API è·¯ç”±
â”‚   â”œâ”€â”€ auth.py          # JWT èªè­‰
â”‚   â”œâ”€â”€ config.py        # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py      # è³‡æ–™åº«é€£æ¥
â”‚   â””â”€â”€ dependencies.py  # ä¾è³´æ³¨å…¥
â”œâ”€â”€ web/
â”‚   â””â”€â”€ index.html       # å‰ç«¯é é¢
â”œâ”€â”€ main.py              # FastAPI ä¸»ç¨‹å¼
â”œâ”€â”€ requirements.txt     # Python ä¾è³´
â”œâ”€â”€ .env                 # ç’°å¢ƒè®Šæ•¸
â””â”€â”€ README.md           # æœ¬æ–‡ä»¶
```

### Step 2: å®‰è£ä¾è³´

```bash
cd backend
pip install -r requirements.txt
```

### Step 3: è¨­å®šè³‡æ–™åº«

1. å»ºç«‹è³‡æ–™åº«ï¼š

```sql
CREATE DATABASE fixture_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

2. åŸ·è¡Œåˆå§‹åŒ–è…³æœ¬ (ä½¿ç”¨ Phase 1 æä¾›çš„ init_database.sql)ï¼š

```bash
mysql -u root -p fixture_management < init_database.sql
```

### Step 4: è¨­å®šç’°å¢ƒè®Šæ•¸

å»ºç«‹ `.env` æª”æ¡ˆï¼š

```env
# è³‡æ–™åº«é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_NAME=fixture_management
DATABASE_USER=root
DATABASE_PASSWORD=your_password_here

# API é…ç½®
API_TITLE=æ²»å…·ç®¡ç†ç³»çµ± API
API_VERSION=2.0.0

# ä¸Šå‚³ç›®éŒ„
UPLOAD_DIR=./uploads
```

### Step 5: å•Ÿå‹•ç³»çµ±

```bash
python main.py
```

æˆ–ä½¿ç”¨ uvicornï¼š

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### Step 6: è¨ªå•ç³»çµ±

- ğŸŒ **ç³»çµ±é¦–é **: http://localhost:8000/
- ğŸ“š **API æ–‡ä»¶**: http://localhost:8000/docs
- ğŸ“– **ReDoc**: http://localhost:8000/redoc
- ğŸ–¥ï¸ **å‰ç«¯é é¢**: http://localhost:8000/web/index.html

---

## ğŸ“š API æ–‡ä»¶

### èªè­‰ API

#### ç™»å…¥
```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

å›æ‡‰ï¼š
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin"
  }
}
```

#### ä½¿ç”¨ Token
```http
GET /api/fixtures
Authorization: Bearer <your_token>
```

### æ²»å…·ç®¡ç† API

#### æŸ¥è©¢æ²»å…·åˆ—è¡¨
```http
GET /api/fixtures?skip=0&limit=100&status_filter=æ­£å¸¸
```

#### å»ºç«‹æ²»å…·
```http
POST /api/fixtures
Authorization: Bearer <token>
Content-Type: application/json

{
  "fixture_id": "L-00017",
  "fixture_name": "ä¸»æ¿æ¸¬è©¦æ²»å…· A",
  "self_purchased_qty": 100,
  "customer_supplied_qty": 50,
  "replacement_cycle": 30.0,
  "cycle_unit": "uses",
  "status": "æ­£å¸¸"
}
```

### é–‹ç«™æ•¸æŸ¥è©¢ API â­

#### æŸ¥è©¢æ©Ÿç¨®æœ€å¤§é–‹ç«™æ•¸
```http
GET /api/models/EDS-518A-SS-SC-80/max-stations
```

å›æ‡‰ï¼š
```json
{
  "model_id": "EDS-518A-SS-SC-80",
  "model_name": "EDS-518A äº¤æ›å™¨",
  "stations": [
    {
      "station_id": 1,
      "station_code": "T1_MP",
      "station_name": "T1 ä¸»æ¿æ¸¬è©¦ç«™",
      "max_stations": 1,
      "bottleneck_fixture": "L-33-14 (æ¸¬è©¦æ²»å…·B)",
      "bottleneck_available": 1,
      "bottleneck_required": 1
    }
  ]
}
```

### æ”¶æ–™ API

#### æ‰¹é‡æ”¶æ–™
```http
POST /api/receipts
Authorization: Bearer <token>
Content-Type: application/json

{
  "receipt_type": "batch",
  "vendor": "ABC ä¾›æ‡‰å•†",
  "order_no": "PO20251107001",
  "fixture_code": "L-00017",
  "serial_start": "001",
  "serial_end": "010",
  "note": "å“è³ªè‰¯å¥½"
}
```

#### å°‘é‡æ”¶æ–™
```http
POST /api/receipts
Authorization: Bearer <token>
Content-Type: application/json

{
  "receipt_type": "individual",
  "vendor": "ABC ä¾›æ‡‰å•†",
  "order_no": "PO20251107002",
  "fixture_code": "L-00017",
  "serials": "A001, A002, A003",
  "note": "å°‘é‡è£œè²¨"
}
```

å®Œæ•´ API æ–‡ä»¶è«‹è¨ªå•: http://localhost:8000/docs

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ models/                    # Pydantic è³‡æ–™æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user.py               # ä½¿ç”¨è€…æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ owner.py              # è² è²¬äººæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ station.py            # ç«™é»æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ fixture.py            # æ²»å…·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ receipt.py            # æ”¶é€€æ–™æ¨¡å‹
â”‚   â”‚   â””â”€â”€ log.py                # è¨˜éŒ„æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ routers/                   # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth_router.py        # èªè­‰ API
â”‚   â”‚   â”œâ”€â”€ fixtures_router.py    # æ²»å…·ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ receipts_router.py    # æ”¶æ–™ API
â”‚   â”‚   â”œâ”€â”€ returns_router.py     # é€€æ–™ API
â”‚   â”‚   â”œâ”€â”€ logs_router.py        # è¨˜éŒ„ API
â”‚   â”‚   â””â”€â”€ models_router.py      # æ©Ÿç¨®ç®¡ç† API
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                     # å·¥å…·æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ password.py           # å¯†ç¢¼å·¥å…·
â”‚   â”‚   â””â”€â”€ validators.py         # è³‡æ–™é©—è­‰
â”‚   â”‚
â”‚   â”œâ”€â”€ auth.py                    # JWT èªè­‰è™•ç†
â”‚   â”œâ”€â”€ config.py                  # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ database.py                # è³‡æ–™åº«é€£æ¥
â”‚   â””â”€â”€ dependencies.py            # ä¾è³´æ³¨å…¥
â”‚
â”œâ”€â”€ web/
â”‚   â””â”€â”€ index.html                 # å‰ç«¯ä»‹é¢
â”‚
â”œâ”€â”€ uploads/                       # æª”æ¡ˆä¸Šå‚³ç›®éŒ„
â”‚
â”œâ”€â”€ main.py                        # FastAPI ä¸»ç¨‹å¼
â”œâ”€â”€ requirements.txt               # Python ä¾è³´æ¸…å–®
â”œâ”€â”€ .env                          # ç’°å¢ƒè®Šæ•¸ (éœ€è‡ªå»º)
â””â”€â”€ README.md                      # èªªæ˜æ–‡ä»¶
```

---

## ğŸ—„ï¸ è³‡æ–™åº«è¨­è¨ˆ

### è³‡æ–™è¡¨ (12 å€‹)

1. **users** - ä½¿ç”¨è€…
2. **owners** - è² è²¬äºº
3. **fixtures** - æ²»å…·ä¸»æª”
4. **machine_models** - æ©Ÿç¨®
5. **stations** - ç«™é»
6. **model_stations** - æ©Ÿç¨®-ç«™é»é—œè¯
7. **fixture_requirements** - æ²»å…·éœ€æ±‚
8. **fixture_deployments** - æ²»å…·éƒ¨ç½²
9. **usage_logs** - ä½¿ç”¨è¨˜éŒ„
10. **replacement_logs** - æ›´æ›è¨˜éŒ„
11. **receipts** - æ”¶æ–™è¨˜éŒ„
12. **returns_table** - é€€æ–™è¨˜éŒ„

### è¦–åœ– (2 å€‹)

1. **view_fixture_status** - æ²»å…·ç‹€æ³ç¸½è¦½
2. **view_model_max_stations** - æ©Ÿç¨®æœ€å¤§é–‹ç«™æ•¸

### è§¸ç™¼å™¨ (3 å€‹)

1. **trg_replacement_insert** - è‡ªå‹•æ›´æ–°æ›´æ›æ—¥æœŸ
2. **trg_replacement_delete** - åˆªé™¤å¾Œé‡ç®—æ—¥æœŸ
3. **trg_replacement_update** - æ›´æ–°å¾Œé‡ç®—æ—¥æœŸ

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½èªªæ˜

### é–‹ç«™æ•¸è¨ˆç®—é‚è¼¯

ç³»çµ±æœƒæ ¹æ“šä»¥ä¸‹è³‡è¨Šè¨ˆç®—æœ€å¤§é–‹ç«™æ•¸ï¼š

1. **æ²»å…·éœ€æ±‚**: æ¯å€‹æ©Ÿç¨®åœ¨æ¯å€‹ç«™é»éœ€è¦çš„æ²»å…·ç¨®é¡å’Œæ•¸é‡
2. **æ²»å…·åº«å­˜**: æ¯å€‹æ²»å…·çš„å¯ç”¨æ•¸é‡ (è‡ªè³¼ + å®¢ä¾›)
3. **è¨ˆç®—å…¬å¼**: `æœ€å¤§é–‹ç«™æ•¸ = MIN(åº«å­˜æ•¸é‡ / éœ€æ±‚æ•¸é‡)` 

ç¯„ä¾‹ï¼š
- T1_MP ç«™éœ€è¦ï¼šL-00017 Ã— 8, L-33-14 Ã— 1
- åº«å­˜ï¼šL-00017 æœ‰ 2455 å€‹, L-33-14 æœ‰ 1 å€‹
- è¨ˆç®—ï¼š
  - L-00017: 2455 / 8 = 306 ç«™
  - L-33-14: 1 / 1 = 1 ç«™
- **çµæœ**: æœ€å¤šåªèƒ½é–‹ **1 ç«™** (å—é™æ–¼ L-33-14)

### æ²»å…·æ›´æ›åˆ¤æ–·

ç³»çµ±è‡ªå‹•åˆ¤æ–·æ²»å…·æ˜¯å¦éœ€è¦æ›´æ›ï¼š

**æŒ‰ä½¿ç”¨æ¬¡æ•¸:**
- å¦‚æœ `ç´¯è¨ˆä½¿ç”¨æ¬¡æ•¸ >= æ›´æ›é€±æœŸ` â†’ éœ€æ›´æ›

**æŒ‰å¤©æ•¸:**
- å¦‚æœ `(ä»Šå¤© - æœ€å¾Œæ›´æ›æ—¥æœŸ) >= æ›´æ›é€±æœŸ` â†’ éœ€æ›´æ›

---

## â“ å¸¸è¦‹å•é¡Œ

### Q1: å¦‚ä½•é‡è¨­ç®¡ç†å“¡å¯†ç¢¼ï¼Ÿ

ä½¿ç”¨ MySQL ç›´æ¥æ›´æ–°ï¼š

```sql
-- ä½¿ç”¨ bcrypt åŠ å¯†çš„å¯†ç¢¼ "admin123"
UPDATE users 
SET password_hash = '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYqGqbqA1Im'
WHERE username = 'admin';
```

### Q2: Token éæœŸæ€éº¼è¾¦ï¼Ÿ

é‡æ–°ç™»å…¥å–å¾—æ–° Tokenï¼Œæˆ–å¯¦ä½œ Token åˆ·æ–°æ©Ÿåˆ¶ã€‚

### Q3: å¦‚ä½•å‚™ä»½è³‡æ–™åº«ï¼Ÿ

```bash
mysqldump -u root -p fixture_management > backup_$(date +%Y%m%d).sql
```

### Q4: å¦‚ä½•é‚„åŸè³‡æ–™åº«ï¼Ÿ

```bash
mysql -u root -p fixture_management < backup_20251107.sql
```

### Q5: å¦‚ä½•ä¿®æ”¹ JWT å¯†é‘°ï¼Ÿ

ç·¨è¼¯ `app/auth.py` ä¸­çš„ `SECRET_KEY`ï¼š

```python
SECRET_KEY = "your-new-secret-key-here"
```

âš ï¸ **æ³¨æ„**: ä¿®æ”¹å¾Œæ‰€æœ‰ç¾æœ‰ Token éƒ½æœƒå¤±æ•ˆã€‚

### Q6: å¦‚ä½•éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒï¼Ÿ

1. é—œé–‰ FastAPI çš„ `reload` æ¨¡å¼
2. ä½¿ç”¨ Gunicorn + Uvicorn workers
3. è¨­å®š CORS ç‚ºç‰¹å®šåŸŸå
4. ä½¿ç”¨ HTTPS
5. è¨­å®šé˜²ç«ç‰†
6. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†å¯†é‘°

### Q7: æ”¯æ´å“ªäº›è³‡æ–™åº«ï¼Ÿ

ç›®å‰æ”¯æ´ MySQL 8.0+ã€‚å¦‚éœ€æ”¯æ´ PostgreSQLï¼Œéœ€è¦ä¿®æ”¹ SQL èªæ³•ã€‚

---

## ğŸ”§ é–‹ç™¼æŒ‡å—

### æ–°å¢ API ç«¯é»

1. åœ¨ `app/models/` å»ºç«‹ Pydantic æ¨¡å‹
2. åœ¨ `app/routers/` å»ºç«‹è·¯ç”±æª”æ¡ˆ
3. åœ¨ `main.py` è¨»å†Šè·¯ç”±

ç¯„ä¾‹ï¼š
```python
# app/routers/example.py
from fastapi import APIRouter

router = APIRouter(prefix="/example", tags=["ç¯„ä¾‹"])

@router.get("/")
async def list_examples():
    return {"message": "Hello"}

# main.py
from routers import example
app.include_router(example.router, prefix="/api")
```

### åŸ·è¡Œæ¸¬è©¦

```bash
pytest tests/
```

### ç¨‹å¼ç¢¼æ ¼å¼åŒ–

```bash
black .
flake8 .
```

---

## ğŸ“ æ›´æ–°æ—¥èªŒ

### v2.0.0 (2025-11-07)
- âœ¨ å…¨æ–°æ¶æ§‹é‡æ§‹
- âœ¨ JWT èªè­‰ç³»çµ±
- âœ¨ é–‹ç«™æ•¸æ™ºèƒ½è¨ˆç®—
- âœ¨ æ‰¹é‡æ“ä½œæ”¯æ´
- âœ¨ å®Œæ•´çš„ API æ–‡ä»¶
- âœ¨ è³‡æ–™åº«è§¸ç™¼å™¨å’Œè¦–åœ–
- âœ¨ å‰ç«¯ä»‹é¢å„ªåŒ–

---

## ğŸ“„ æˆæ¬Š

æœ¬å°ˆæ¡ˆç‚ºå…§éƒ¨ä½¿ç”¨ç³»çµ±ã€‚

---

## ğŸ‘¥ é–‹ç™¼åœ˜éšŠ

æ²»å…·ç®¡ç†ç³»çµ±é–‹ç™¼åœ˜éšŠ

---

## ğŸ“® è¯çµ¡æ–¹å¼

å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œè«‹è¯çµ¡é–‹ç™¼åœ˜éšŠã€‚

---

**æ„Ÿè¬ä½¿ç”¨æ²»å…·ç®¡ç†ç³»çµ±ï¼** ğŸ‰